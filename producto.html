<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | SpaceYisusShop</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <a href="index.html" class="logo">ü™ê SpaceYisusShop</a>
  </header>

  <main id="product-page" class="container">
    <section id="product-detail" class="product-detail">
      <div id="product-image-container">
        <img id="product-image" alt="Imagen del producto" />
      </div>
      <div class="product-info">
        <h1 id="product-name"></h1>
        <p id="product-description"></p>
        <h2 id="product-price"></h2>
        <button id="buy-button">üõí Comprar</button>
      </div>
    </section>

    <section id="related-products" class="related">
      <h3>Productos relacionados</h3>
      <div id="related-container" class="related-grid"></div>
    </section>
  </main>

  <footer>
    <p>¬© 2025 SpaceYisusShop</p>
  </footer>

  <script type="module">
    import { ProductService } from './services/product.js'

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üìÑ P√°gina cargada, buscando producto...')

      const url = new URL(window.location.href)
      console.log('üåê URL completa:', url.href)

      // üîé Intentar primero con ?id=
      let productId = url.searchParams.get('id')

      // üß© Si no hay ?id=, obtener el √∫ltimo segmento del path
      if (!productId) {
        const pathParts = window.location.pathname.split('/')
        productId = pathParts.pop() || pathParts.pop() // √∫ltimo segmento no vac√≠o
      }

      console.log('üÜî Identificador del producto de la URL:', productId)

      if (!productId) {
        console.error('‚ùå No se proporcion√≥ un identificador de producto en la URL')
        document.getElementById('product-detail').innerHTML = `
          <p class="error">No se encontr√≥ el producto solicitado.</p>
        `
        return
      }

      try {
        const product = await ProductService.getProductById(productId)
        if (!product) throw new Error('Producto no encontrado')

        console.log('‚úÖ Producto cargado:', product.name)

        // Rellenar los datos en el HTML
        document.getElementById('product-image').src = product.image_url || ''
        document.getElementById('product-name').textContent = product.name
        document.getElementById('product-description').textContent = product.description
        document.getElementById('product-price').textContent = `$${Number(product.price).toLocaleString('es-CO')}`

        // Cargar productos relacionados
        const related = await ProductService.getRelatedProducts(null, product.id, product.name, 4)
        const relatedContainer = document.getElementById('related-container')
        relatedContainer.innerHTML = ''

        if (related.length === 0) {
          relatedContainer.innerHTML = '<p>No hay productos relacionados.</p>'
        } else {
          related.forEach(r => {
            const div = document.createElement('div')
            div.className = 'related-item'
            div.innerHTML = `
              <a href="/producto/${r.slug}">
                <img src="${r.image_url}" alt="${r.name}" />
                <h4>${r.name}</h4>
                <p>$${Number(r.price).toLocaleString('es-CO')}</p>
              </a>
            `
            relatedContainer.appendChild(div)
          })
        }
      } catch (error) {
        console.error('üí• Error al cargar el producto:', error)
        document.getElementById('product-detail').innerHTML = `
          <p class="error">Error al cargar el producto: ${error.message}</p>
        `
      }
    })
  </script>
</body>
</html>

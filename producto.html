<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | SpaceYisusShop</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <a href="index.html" class="logo">ü™ê SpaceYisusShop</a>
  </header>

  <main id="product-page" class="container">
    <section id="product-detail" class="product-detail">
      <div id="product-image-container">
        <img id="product-image" alt="Imagen del producto" />
      </div>
      <div class="product-info">
        <h1 id="product-name"></h1>
        <p id="product-description"></p>
        <h2 id="product-price"></h2>
        <button id="buy-button">üõí Comprar</button>
      </div>
    </section>

    <section id="related-products" class="related">
      <h3>Productos relacionados</h3>
      <div id="related-container" class="related-grid"></div>
    </section>
  </main>

  <footer>
    <p>¬© 2025 SpaceYisusShop</p>
  </footer>

  <script type="module">
    // Usar la misma URL base de la p√°gina actual para la API
    const API_URL = window.location.origin + '/api';

    // Funci√≥n para obtener un producto por ID o slug
    async function getProductoById(id) {
      try {
        const response = await fetch(`${API_URL}/productos/${encodeURIComponent(id)}`);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Producto no encontrado');
        }
        return await response.json();
      } catch (error) {
        console.error('Error al obtener el producto:', error);
        throw error;
      }
    }

    // Funci√≥n para obtener productos por categor√≠a
    async function getProductosByCategoria(categoria) {
      try {
        const response = await fetch(`${API_URL}/productos?categoria=${encodeURIComponent(categoria)}`);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Error al cargar productos relacionados');
        }
        return await response.json();
      } catch (error) {
        console.error('Error al obtener productos relacionados:', error);
        return [];
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üìÑ P√°gina cargada, buscando producto...');

      const url = new URL(window.location.href);
      console.log('üåê URL completa:', url.href);

      // üîé Intentar primero con ?id=
      let productId = url.searchParams.get('id');

      // üß© Si no hay ?id=, obtener el √∫ltimo segmento del path
      if (!productId) {
        const pathParts = window.location.pathname.split('/');
        productId = pathParts.pop() || pathParts.pop(); // √∫ltimo segmento no vac√≠o
      }

      console.log('üÜî Identificador del producto de la URL:', productId);

      if (!productId) {
        console.error('‚ùå No se proporcion√≥ un identificador de producto en la URL');
        document.getElementById('product-detail').innerHTML = `
          <div class="error">
            <h2>Producto no encontrado</h2>
            <p>Lo sentimos, no pudimos encontrar el producto solicitado.</p>
            <a href="/" class="back-link">‚Üê Volver a la tienda</a>
          </div>
        `;
        return;
      }

      // Mostrar indicador de carga
      const productDetail = document.getElementById('product-detail');
      productDetail.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Cargando producto...</p>
        </div>
      `;

      try {
        console.log('üîç Buscando producto con ID:', productId);
        const product = await getProductoById(productId);
        
        if (!product) {
          throw new Error('Producto no encontrado');
        }

        console.log('‚úÖ Producto cargado:', product);

        // Rellenar los datos en el HTML
        const productImage = document.getElementById('product-image');
        const productName = document.getElementById('product-name');
        const productDescription = document.getElementById('product-description');
        const productPrice = document.getElementById('product-price');

        // Actualizar la imagen
        if (product.imagen || product.image_url) {
          productImage.src = product.imagen || product.image_url;
          productImage.alt = product.nombre || product.name || 'Imagen del producto';
          productImage.style.display = 'block';
        } else {
          productImage.style.display = 'none';
        }

        // Actualizar el resto de la informaci√≥n
        productName.textContent = product.nombre || product.name || 'Producto sin nombre';
        productDescription.textContent = product.descripcion || product.description || 'Sin descripci√≥n disponible';
        
        // Formatear el precio
        if (product.precio || product.price) {
          const precio = product.precio || product.price;
          productPrice.textContent = `$${Number(precio).toLocaleString('es-CO')}`;
        } else {
          productPrice.textContent = 'Precio no disponible';
        }

        // Cargar productos relacionados por categor√≠a
        const categoria = product.categoria || product.category;
        let related = [];
        
        if (categoria) {
          related = await getProductosByCategoria(categoria);
          // Filtrar el producto actual
          related = related.filter(p => 
            (p._id !== product._id && p._id !== product.id) && 
            (p.id !== product._id && p.id !== product.id)
          );
          // Limitar a 4 productos
          related = related.slice(0, 4);
        }

        const relatedContainer = document.getElementById('related-container');
        relatedContainer.innerHTML = '';

        if (related.length === 0) {
          relatedContainer.innerHTML = '<p>No hay productos relacionados.</p>';
        } else {
          related.forEach(r => {
            const div = document.createElement('div');
            div.className = 'related-item';
            const slug = r.slug || r._id || r.id;
            const nombre = r.nombre || r.name || 'Producto sin nombre';
            const imagen = r.imagen || r.image_url || '';
            const precio = r.precio || r.price || 0;
            
            div.innerHTML = `
              <a href="/producto/${slug}">
                ${imagen ? `<img src="${imagen}" alt="${nombre}" />` : '<div class="no-image">Sin imagen</div>'}
                <h4>${nombre}</h4>
                <p>$${Number(precio).toLocaleString('es-CO')}</p>
              </a>
            `;
            relatedContainer.appendChild(div);
          });
        }
      } catch (error) {
        console.error('üí• Error al cargar el producto:', error)
        document.getElementById('product-detail').innerHTML = `
          <p class="error">Error al cargar el producto: ${error.message}</p>
        `
      }
    })
  </script>
</body>
</html>

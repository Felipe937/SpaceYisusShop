<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | SpaceYisusShop</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <a href="index.html" class="logo">ü™ê SpaceYisusShop</a>
  </header>

  <main id="product-page" class="container">
    <section id="product-detail" class="product-detail">
      <div id="product-image-container">
        <img id="product-image" alt="Imagen del producto" />
      </div>
      <div class="product-info">
        <h1 id="product-name"></h1>
        <p id="product-description"></p>
        <div class="product-price" id="product-price"></div>
        <button id="buy-button" class="btn-primary">A√±adir al carrito</button>
      </div>
    </section>

    <section id="related-products" class="related">
      <h3>Productos relacionados</h3>
      <div id="related-container" class="related-grid"></div>
    </section>
  </main>

  <footer>
    <p>¬© 2025 SpaceYisusShop</p>
  </footer>

  <script type="module">
    // Funci√≥n para obtener producto desde MongoDB API
    async function getProductoById(id) {
        try {
            console.log('üîç Buscando producto en API con ID:', id);
            const response = await fetch(`/api/producto/${id}`);
            
            if (!response.ok) {
                throw new Error('Producto no encontrado en la API');
            }
            
            const product = await response.json();
            console.log('‚úÖ Producto encontrado:', product);
            return product;
        } catch (error) {
            console.error('‚ùå Error al obtener el producto:', error);
            throw error;
        }
    }

    // Funci√≥n para obtener productos relacionados
    async function getProductosRelacionados(categoriaActual, productoActualId) {
        try {
            const response = await fetch('/api/productos');
            const todosProductos = await response.json();
            
            // Filtrar productos de la misma categor√≠a, excluyendo el actual
            return todosProductos.filter(p => 
                p.categoria === categoriaActual && 
                p._id !== productoActualId
            ).slice(0, 4); // Limitar a 4 productos
        } catch (error) {
            console.error('Error cargando productos relacionados:', error);
            return [];
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üìÑ P√°gina cargada, buscando producto...');

        // Obtener ID del producto de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        console.log('üÜî ID del producto:', productId);

        if (!productId) {
            mostrarError('No se proporcion√≥ un ID de producto');
            return;
        }

        // Mostrar loading
        mostrarLoading();

        try {
            // Obtener producto desde MongoDB
            const product = await getProductoById(productId);
            
            if (!product) {
                throw new Error('Producto no encontrado');
            }

            // Mostrar producto en la p√°gina
            mostrarProducto(product);

            // Cargar productos relacionados
            if (product.categoria) {
                const relacionados = await getProductosRelacionados(product.categoria, product._id);
                mostrarProductosRelacionados(relacionados);
            }

        } catch (error) {
            console.error('üí• Error al cargar el producto:', error);
            mostrarError(`Error: ${error.message}`);
        }
    });

    // Funci√≥n para mostrar loading
    function mostrarLoading() {
        const productDetail = document.getElementById('product-detail');
        productDetail.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando producto...</p>
            </div>
        `;
    }

    // Funci√≥n para mostrar el producto
    function mostrarProducto(product) {
        const productImage = document.getElementById('product-image');
        const productName = document.getElementById('product-name');
        const productDescription = document.getElementById('product-description');
        const productPrice = document.getElementById('product-price');
        const buyButton = document.getElementById('buy-button');

        // Imagen
        if (product.imagen) {
            productImage.src = product.imagen;
            productImage.alt = product.nombre;
            productImage.style.display = 'block';
        } else {
            productImage.style.display = 'none';
        }

        // Informaci√≥n
        productName.textContent = product.nombre || 'Producto sin nombre';
        productDescription.textContent = product.descripcion || 'Sin descripci√≥n disponible';
        productPrice.textContent = product.precio ? `$${Number(product.precio).toLocaleString('es-CO')}` : 'Precio no disponible';

        // Bot√≥n de compra
        buyButton.onclick = () => agregarAlCarrito(product._id);
    }

    // Funci√≥n para mostrar productos relacionados
    function mostrarProductosRelacionados(productos) {
        const relatedContainer = document.getElementById('related-container');
        
        if (!productos || productos.length === 0) {
            relatedContainer.innerHTML = '<p>No hay productos relacionados disponibles.</p>';
            return;
        }

        relatedContainer.innerHTML = productos.map(producto => `
            <div class="related-item">
                <a href="/producto.html?id=${producto._id}">
                    ${producto.imagen ? 
                        `<img src="${producto.imagen}" alt="${producto.nombre}" />` : 
                        '<div class="no-image">üì∑ Sin imagen</div>'
                    }
                    <h4>${producto.nombre}</h4>
                    <p>$${Number(producto.precio).toLocaleString('es-CO')}</p>
                </a>
            </div>
        `).join('');
    }

    // Funci√≥n para mostrar error
    function mostrarError(mensaje) {
        document.getElementById('product-detail').innerHTML = `
            <div class="error">
                <h2>Producto no encontrado</h2>
                <p>${mensaje}</p>
                <a href="index.html" class="back-link">‚Üê Volver a la tienda</a>
            </div>
        `;
    }

    // Funci√≥n para agregar al carrito
    function agregarAlCarrito(productoId) {
        console.log('üõí Agregando al carrito:', productoId);
        // Aqu√≠ va tu l√≥gica del carrito
        alert(`Producto ${productoId} agregado al carrito`);
    }
  </script>
</body>
</html>
